#!/bin/bash

APP_NAME="CandaApp"
APP_PATH="$HOME/Desktop/$APP_NAME.app"
EXECUTABLE_PATH="$APP_PATH/Contents/MacOS/launcher"
PLIST_PATH="$APP_PATH/Contents/Info.plist"

# Remove existing app if present
rm -rf "$APP_PATH"

# Create .app structure
mkdir -p "$APP_PATH/Contents/MacOS"
mkdir -p "$APP_PATH/Contents/Resources"

# Create executable launcher script
cat << 'EOF' > "$EXECUTABLE_PATH"
#!/bin/bash
osascript -e 'tell application "Terminal"
    do script "
        clear
        echo Initializing Hyper Mode...
        sleep 2
        echo Downloading AI core...
        sleep 2
        for i in {1..100}; do
          echo -ne \"Installing: \$i% complete\\r\"
          sleep 0.03
        done
        echo \"
        COMPLETE.
        \"
        sleep 1
        echo 'This is a prank!'
        say \"This is a prank!\"
    "
    activate
end tell'
EOF

chmod +x "$EXECUTABLE_PATH"

# Create Info.plist
cat << EOF > "$PLIST_PATH"
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
  <dict>
    <key>CFBundleName</key>
    <string>$APP_NAME</string>
    <key>CFBundleDisplayName</key>
    <string>$APP_NAME</string>
    <key>CFBundleIdentifier</key>
    <string>com.fake.candaapp</string>
    <key>CFBundleVersion</key>
    <string>1.0</string>
    <key>CFBundlePackageType</key>
    <string>APPL</string>
    <key>CFBundleExecutable</key>
    <string>launcher</string>
  </dict>
</plist>
EOF

# Remove quarantine attribute (critical!)
xattr -cr "$APP_PATH"

# (Optional) Codesign it ad-hoc so macOS Gatekeeper accepts it
codesign --force --deep --sign - "$APP_PATH"

# Done
echo "âœ… $APP_NAME created successfully at: $APP_PATH"
open "$APP_PATH"
